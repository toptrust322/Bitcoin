{% comment %}

This file is licensed under the MIT License (MIT) available on
http://opensource.org/licenses/MIT.
{% endcomment %}

<div class="walletmenu" id="walletmenu">
{% assign platformsByPlatform = site.platforms | group_by: "platform" %}
  {% if page.url contains "en/choose-your-wallet.html" %}
    {% assign walletTypeTab = "" | append: "" %}
  {% else %}
    {% assign walletTypeTab = "" | append: "is-hidden" %}
  {% endif %}
  <p class="wallet-acc-toggle wallet-acc-toggle-1 {{walletTypeTab}}" data-toggle>Select wallet Type</p>
  {% if page.url contains "en/choose-your-wallet.html" %}
    {% assign walletTypeList = "" | append: "is-hidden" %}
  {% else %}
    {% assign walletTypeList = "" | append: "is-fullwidth" %}
  {% endif %}
  <ul class="walletmenu-main-list {{walletTypeList}}">
  {% for platform in platformsByPlatform %}

    {% comment %}
      ! WORKAROUND START
      Working around an issue with getting proper platform name from the list
      of platforms. After original group_by, the "name" key becomes a stringified
      hash. So we need to make these "hackish" transformations to make it working
      properly.
    {% endcomment %}
    {% capture platformName %}{{ platform.name | split: "=>" | last | split: '"' }}{% endcapture %}
    {% assign platformName = platformName | trim | replace: '}' '' | replace: ' ' '' %}
    {% comment %}
      ! WORKAROUND END
    {% endcomment %}

    {% assign platformClass = "wallet-" | append: platformName %}
    {% if page.id contains platformName %}
      {% assign platformClass = platformClass | append: " pseudo-acc active" %}
    {% elsif page.url contains "en/choose-your-wallet.html" %}
        {% assign platformClass = platformClass | append: "" %}
    {% else %}
      {% assign platformClass = platformClass | append: " is-hidden" %}
    {% endif %}
    <li class="js-acc-item acc-item {{ platformClass }}">
      {% if platformName == 'hardware' or platformName == 'web' %}
      {% assign platformHref = "/" | append: page.lang | append: "/wallets/" | append: platformName | append: "/" %}
        <a data-item-target href="{{ platformHref }}">{% translate walletcat{{platformName}} choose-your-wallet %}</a>
      {% else %}
        <a data-item-target class="wallet-platform-link">{% translate walletcat{{platformName}} choose-your-wallet %}</a>
      {% endif %}
      {% if platform.items.size > 1 %}
      <div class="walletmenu-subaccordion">
        {% if page.url contains "en/choose-your-wallet.html" %}
          {% assign walletOsTab = "" | append: "" %}
        {% else %}
          {% assign walletOsTab = "" | append: "is-hidden" %}
        {% endif %}
      <p class="wallet-acc-toggle wallet-acc-toggle-2 {{walletOsTab}}" data-toggle>Select Operating system</p>
      {% if page.url contains "en/choose-your-wallet.html" %}
        {% assign walletOsList = "" | append: "is-hidden" %}
      {% else %}
        {% assign walletOsList = "" | append: "is-fullwidth" %}
      {% endif %}
      <ul class="walletmenu-os-list {{walletOsList}}">
        {% for item in platform.items %}
          {% assign osClass = "wallet-" | append: item.os.name %}
          {% if page.id contains item.id %}
            {% assign osClass = osClass | append: " pseudo-acc active" %}
          {% else %}
            {% assign osClass = osClass | append: " is-hidden" %}
          {% endif %}
          <li class="js-acc-subitem acc-item {{ osClass }}">
            <a  href="/{{ page.lang }}/wallets/{{ platformName }}/{{ item.os.name }}/">
              {% translate platform{{item.os.name}} choose-your-wallet %}
            </a>
          </li>
        {% endfor %}
        </ul>
      </div>
      {% endif %}
    </li>
  {% endfor %}
  </ul>
</div>

<script>
  var mainWalletList = document.querySelector(".walletmenu-main-list");
  var accordionToggleTabs = document.getElementsByClassName("wallet-acc-toggle");
  var walletMenu = document.querySelector(".walletmenu");
  var accSub = document.getElementsByClassName("js-acc-subitem");
  var acc = document.getElementsByClassName("js-acc-item");
  
  // Add margin-bottom for walletmenu depending on the height of the second accordion          
  function calculateHeight(element) {
    walletMenu.style.marginBottom = element.offsetHeight + 'px'; 
  }  
  
  function accordionDesktop() {
    for (var i = 0; i < acc.length; i++) {
      acc[i].addEventListener("click", function(event) {
        if (document.documentElement.clientWidth > 768) {
          var activeItem = event.target.parentNode;
          var activeOsAccordion = activeItem.querySelector(".walletmenu-subaccordion");

          activeItem.classList.toggle("is-active");

          if (activeOsAccordion.classList.contains("walletmenu-subaccordion")) {
            calculateHeight(activeOsAccordion);
          }

          // Hide not selected list items
          for (var index = 0; index < acc.length; index++) {
            if (!(activeItem == acc[index])) {
              acc[index].classList.remove("is-active");
            }
          }
          
        }
      });
    }
  }
  accordionDesktop();
  
  function platformAcc() {
    for (var i = 0; i < acc.length; i++) {
      acc[i].addEventListener("click", function (event) {

        if (document.documentElement.clientWidth <= 768) {
          
          if (event.target.parentNode.classList.contains("pseudo-acc")) {
            event.preventDefault();
          }

          if (!event.target.hasAttribute('data-item-target')) {
            return;
          } else {

            var activeItem = event.target.parentNode;
            var activeList = activeItem.parentNode;
            var activeTab = activeList.previousElementSibling;
            var activeOsAccordion = activeItem.querySelector(".walletmenu-subaccordion");

            // Made selected list item as pseudo accordion tab
            activeItem.classList.toggle("pseudo-acc");
            // Made parent of selected list item is fullwidth
            activeList.classList.toggle("is-fullwidth");
            // Hide tab
            activeTab.classList.toggle("is-hidden");

            // Calculate height of absolute positioned sublist and add margin-bottom for walletmenu
            if (activeOsAccordion.classList.contains("walletmenu-subaccordion")) {
              calculateHeight(activeOsAccordion);
            }

            // Hide not selected list items
            for (var index = 0; index < acc.length; index++) {
              if (!(activeItem == acc[index])) {
                acc[index].classList.toggle("is-hidden");
                acc[index].classList.remove("pseudo-acc");
              }
            }

            for (var a = 0; a < accSub.length; a++) {
              accSub[a].classList.toggle("is-hidden");
              console.log(accSub[a]);              
            }
          }
        }
      });
    }
  }

  function osAcc() {
    for (var i = 0; i < accSub.length; i++) {

      accSub[i].addEventListener("click", function (event) {
        event.stopPropagation();
        if (event.target.parentNode.classList.contains("pseudo-acc")) {
          event.preventDefault();
        }
        
        var activeItem = event.target.parentNode;
        var activeList = activeItem.parentNode;
        var activeTab = activeList.previousElementSibling;
        var activeOsAccordion = activeList.parentNode;
        // Made parent of selected list item is fullwidth
        activeList.classList.toggle("is-fullwidth");
        // Hide tab
        activeTab.classList.toggle("is-hidden");
        
        
        
        for (var a = 0; a < accSub.length; a++) {
          if (!(activeItem == accSub[a])) {
            accSub[a].classList.toggle("is-hidden");
          } else {
            accSub[a].classList.toggle("pseudo-acc");
          }
        }

        // Calculate height of absolute positioned sublist and add margin-bottom for walletmenu
        calculateHeight(activeOsAccordion);
      });
    }
  }

  platformAcc();
  osAcc();
       
  function accordionToggle() {
    for (var i = 0; i < accordionToggleTabs.length; i++) {
      accordionToggleTabs[i].addEventListener("click", function (event) {
        
        if (event.target.hasAttribute('data-toggle')) {
          // p
          event.target.classList.toggle("is-expanded");
          // ul
          event.target.nextElementSibling.classList.toggle("is-hidden");
        }

        if (event.target.classList.contains("wallet-acc-toggle-2")) {
          calculateHeight(event.target.parentNode);
        }
      });
    }
  }

  accordionToggle();

</script>