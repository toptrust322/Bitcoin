{% comment %}
This file is licensed under the MIT License (MIT) available on
http://opensource.org/licenses/MIT.
{% endcomment %}

<div class="helper">
  <div class="container">
    {% include layout/base/helper-intro.html %}
    {% include layout/base/helper-wizard.html %}
  </div>
</div>

<script>
(function() {
  var selectedPlatform;
  var selectedUser;
  var selectedImportantCheckboxes = [];
  var selectedImportantCheckboxes = [];
  var accordionsList = document.querySelectorAll('.js-helper-accordion');
  var headersList = document.querySelectorAll('.helper-header');
  
  function displayRelevantStep(selectedStep) {
    var sectionsList = document.querySelectorAll('.helper-step');

    if (selectedStep !== '0') showWizard();
    
    sectionsList.forEach(function(section) {
      if (section.dataset.step === selectedStep) section.classList.add('visible');
      else section.classList.remove('visible');
    })
  }
  
  function displaySelectedHeaderValues() {
    accordionsList.forEach(function(accordion) {
      var accordionType = accordion.dataset.type;
      var selectedFilters = getUrlParameter(accordionType);

      if (selectedFilters && accordionType === 'important' || accordionType === 'features') {
        var text = selectedFilters.split(',').map(function(s) {
          return s.split('_').join(' ');
        }).join(', ');
        accordion.querySelector('.helper-selected-filter').textContent = text;
      } else if (selectedFilters) {
        var text = document.querySelector('input[value=' + selectedFilters + ']').dataset.text;
        accordion.querySelector('.helper-selected-filter').textContent = text;
      }
    })
  }
  
  function highlightRelevantHeader(step) {    
    step = Number(step);
    
    accordionsList.forEach(function(accordion) {
      var accordionType = accordion.dataset.type;
      var accordionStep = Number(accordion.dataset.number);
      
      if (accordionStep === step) accordion.classList.add('active');
      else accordion.classList.remove('active');

      var selectedFilters = getUrlParameter(accordionType);
      if (selectedFilters && accordionStep !== step) {
        accordion.querySelector('.helper-selected-block').classList.add('visible');
        accordion.classList.add('complete');
      } else {
        accordion.querySelector('.helper-selected-block').classList.remove('visible');
        accordion.classList.remove('complete');
      }
    })      
  }
  
  function showWizard() {
    var wizard = document.querySelector('.js-wizard');
    wizard.classList.add('visible')
  }
  
  function onPlatformRadioChange(radio) {
    var nextButton = document.querySelector('.js-platform-next');
    nextButton.classList.add('visible');
    setUrlParameter(radio.name, radio.value);
    displaySelectedHeaderValues();
  }
  
  function scrollIntoHeader(number) {
    document.querySelector('[data-number="' + number + '"]').scrollIntoView();
  }
  
  function onUserRadioChange(radio) {
    var nextButton = document.querySelector('.js-user-next');
    nextButton.classList.add('visible');
    setUrlParameter(radio.name, radio.value);
    displaySelectedHeaderValues();
  }

  function onImportantCheckboxChange(checkbox) {
    var nextButton = document.querySelector('.js-important-next');
    nextButton.classList.add('visible');
    var filters = [];
    var selectedCheckboxes = document.querySelectorAll('.js-helper-important:checked');
    selectedCheckboxes.forEach(function(input) {
      filters.push(input.value);
    });
    setUrlParameter(checkbox.name, filters);
    displaySelectedHeaderValues();
  }

  function onFeaturesCheckboxChange(checkbox) {
    var nextButton = document.querySelector('.js-features-next');
    nextButton.classList.add('visible');
    var filters = []
    var selectedCheckboxes = document.querySelectorAll('.js-helper-features:checked');
    selectedCheckboxes.forEach(function(input) {
      filters.push(input.value);
    });
    setUrlParameter(checkbox.name, filters);
    displaySelectedHeaderValues();
  }
  
  function setListners() {
    var nextButtons = document.querySelectorAll('.js-helper-next')
    nextButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        var step = this.dataset.selector;
        displayRelevantStep(step);
        setUrlParameter('step', step);
        highlightRelevantHeader(step);
        scrollIntoHeader(step);
      });
    });

    var backButtons = document.querySelectorAll('[data-selector]');
    backButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        var step = this.dataset.selector;
        displayRelevantStep(step);
        setUrlParameter('step', step);
        highlightRelevantHeader(step);
        scrollIntoHeader(step);
      });
    });

    var platformRadioList = document.querySelectorAll('.js-helper-platform');
    platformRadioList.forEach(function(radio) {
      radio.addEventListener('change', function() {
        onPlatformRadioChange(radio);
      });
    });

    var userRadioList = document.querySelectorAll('.js-helper-user');
    userRadioList.forEach(function(radio) {
      radio.addEventListener('change', function() {
        onUserRadioChange(radio);
      });
    });

    var impotantCheckboxesList = document.querySelectorAll('.js-helper-important');
    impotantCheckboxesList.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        onImportantCheckboxChange(checkbox);
      });
    });

    var featuresCheckboxesList = document.querySelectorAll('.js-helper-features');
    featuresCheckboxesList.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        onFeaturesCheckboxChange(checkbox);
      });
    });
  }
  
  function checkInputsValues(parameterName, parameterValues) {
    var filters = parameterValues.split(',');
    var inputValues = [];
    var inputsList = document.getElementsByName(parameterName);
    inputsList.forEach(function(input) {
      inputValues.push(input.value);
    })
    console.log(filters, inputValues)
    for (var i = 0; i < filters.length; i++) {
      var filter = filters[i];
      if (!inputValues.includes(filter)) return false;
    }
    return true;
  }
  
  function verifyPreviousStepsChecks(step) {
    for (var i = step - 1; i > 0; i--) {
      var parameterName = document.querySelector('[data-number="' + i + '"]').dataset.type;
      var parameterValues = getUrlParameter(parameterName);
      if (!!parameterValues && !checkInputsValues(parameterName, parameterValues)) return false;
    }
    return true;
  }
  
  function displayDefaultContent(step) {
    currentStep = Number(step);
    var isWizardStep = currentStep > 0 && currentStep < 5;
    if (isWizardStep && verifyPreviousStepsChecks(step)) {
      displayRelevantStep(step);
      displaySelectedHeaderValues();
      highlightRelevantHeader(step)
    } else {
      displayRelevantStep('0');
      window.history.replaceState(null, null, window.location.pathname);
    }
  }
  
  function init() {
    var step = getUrlParameter('step');
    displayDefaultContent(step);
    setListners();
  }

  init();
})();
</script>